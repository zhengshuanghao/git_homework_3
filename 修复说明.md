# DeepSeek 服务修复说明

## 问题描述
前端输入旅行需求（如"我想去成都，预算5000元"）后，无法正常返回旅行计划。控制台显示错误：
```
[DeepSeekService] 无法解析模型响应，返回占位数据。原始响应前100字符: {"destination": "成都","duration": 5,"budget": 5000,"people": 1,"preferences"
```

## 问题原因
1. **响应被截断**：原始 `max_tokens=4000` 设置可能导致 DeepSeek 模型返回的 JSON 响应被截断，无法形成完整的 JSON 结构
2. **JSON 解析失败**：截断的 JSON 无法被 `json.loads()` 解析，导致返回占位数据
3. **缺少详细日志**：原代码缺少足够的调试信息，难以定位问题

## 修复方案

### 1. 增加 max_tokens 限制
```python
# 从 4000 增加到 8000
response = self._call_api(messages, temperature=0.7, max_tokens=8000)
```

### 2. 改进 system prompt
- 明确要求模型返回**完整的、格式正确的 JSON**
- 添加示例数据，帮助模型理解期望的输出格式
- 强调所有括号和引号必须闭合

### 3. 增强 JSON 解析逻辑
- 添加详细的调试日志，显示响应长度、前后内容
- 改进错误处理，显示具体的解析失败位置
- 增强 JSON 修复功能，处理截断的响应

### 4. 改进 JSON 修复功能
```python
def _attempt_repair_json(self, raw_text):
    # 增加 max_tokens 到 8000
    # 明确要求补全缺失的部分
    # 添加详细的调试日志
```

## 修复效果
✅ 测试通过！模型现在能够：
- 返回完整的 14290 字符的 JSON 响应
- 成功解析为 Python 字典
- 包含完整的 4 天行程、住宿推荐、餐厅推荐等信息

## 测试结果
```
目的地: 成都
天数: 4
预算: 5000
人数: 1
总预算: 5000

行程天数: 4 天
  第 1 天: 5 个活动
  第 2 天: 5 个活动
  第 3 天: 4 个活动
  第 4 天: 3 个活动

建议数量: 3
```

## 使用说明
1. 确保 `.env` 文件中的 DeepSeek API 配置正确
2. 启动应用：`python app.py`
3. 在前端输入旅行需求，如"我想去成都，预算5000元"
4. 系统将正常生成并显示完整的旅行计划

## 注意事项
- 如果仍然遇到 JSON 解析问题，检查控制台日志中的详细错误信息
- 确保网络连接稳定，能够访问火山方舟 API
- 如果响应时间过长，可能是网络延迟或 API 限流
