# 火山方舟流式语音识别配置指南

## 📋 概述

本项目已切换到**火山方舟流式语音识别大模型**，实现以下功能：

1. **语音输入** → 用户说话，实时转换为文字
2. **文字回显** → 识别结果显示在输入框中
3. **生成旅行计划** → 用户点击按钮，调用 DeepSeek 生成旅行计划

---

## 🔧 配置步骤

### 1. 更新 `.env` 文件

请手动编辑 `.env` 文件，替换以下内容：

**删除旧配置（豆包相关）：**
```env
DOUBAO_APP_ID=...
DOUBAO_ACCESS_KEY=...
DOUBAO_SECRET_KEY=...
DOUBAO_MODEL_ID=...
```

**添加新配置（语音识别）：**
```env
# ============================================================
# 火山方舟流式语音识别大模型
# ============================================================
SPEECH_APP_ID=1356755714
SPEECH_ACCESS_KEY=oPxND_k8BQJveNLg7Mdq9VXRvKgFnIlP
SPEECH_SECRET_KEY=Aj8WnzaLDOeWTiIcF9zC-7dN2QPypq6h
SPEECH_MODEL_ID=Speech_Recognition_Seed_streaming2000000451913596898
```

**完整的 .env 文件示例：**
```env
# ============================================================
# AI旅行规划师 - 环境变量配置
# 火山方舟流式语音识别版
# ============================================================

# ============================================================
# 火山方舟流式语音识别大模型
# ============================================================
SPEECH_APP_ID=1356755714
SPEECH_ACCESS_KEY=oPxND_k8BQJveNLg7Mdq9VXRvKgFnIlP
SPEECH_SECRET_KEY=Aj8WnzaLDOeWTiIcF9zC-7dN2QPypq6h
SPEECH_MODEL_ID=Speech_Recognition_Seed_streaming2000000451913596898

# ============================================================
# 高德地图API
# ============================================================
AMAP_API_KEY=62b0a02ed7213d7753d65007051c0c6f
AMAP_API_SECRET=66a262e19c64cdc1109b2c70dd89fee0

# ============================================================
# 火山方舟 DeepSeek LLM API（旅行规划）
# ============================================================
ARK_API_KEY=sk-ef1bae9821a140baaafca8f4ed3495bb
ARK_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
DEEPSEEK_MODEL=deepseek-v3-1-250821

# ============================================================
# Supabase数据库配置
# ============================================================
SUPABASE_URL=https://hfhxiwcuikcmtpcyyevl.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmaHhpd2N1aWtjbXRwY3l5ZXZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzczNDksImV4cCI6MjA3ODExMzM0OX0.u9xX7WOMuYq4fBwJI313vc14OfOuSgabylXqUWFSwTQ

# ============================================================
# Flask配置
# ============================================================
FLASK_SECRET_KEY=your-secret-key-change-in-production
FLASK_ENV=development
```

---

## 🚀 启动应用

### 1. 启动服务器

```bash
python run.py
```

应该看到：
```
============================================================
AI旅行规划师 - 火山方舟流式语音识别版
============================================================
服务器地址: http://localhost:8080
网络地址: http://0.0.0.0:8080
语音服务: 火山方舟流式语音识别大模型
============================================================
```

### 2. 访问应用

打开浏览器：`http://localhost:8080`

---

## 📝 使用流程

### 方式一：语音输入 → 生成旅行计划

1. **选择"语音输入"模式**
2. **点击"开始录音"按钮**
3. **说出旅行需求**，例如：
   - "我想去北京旅游，5天，预算1万元"
   - "想去日本看樱花，带家人，7天时间"
4. **点击"停止录音"**
5. **查看识别结果**（显示在输入框中）
6. **点击"生成旅行计划"按钮**
7. **查看AI生成的旅行计划**

### 方式二：文字输入 → 生成旅行计划

1. **选择"文字输入"模式**
2. **在文本框中输入旅行需求**
3. **点击"生成旅行计划"按钮**
4. **查看AI生成的旅行计划**

---

## 🔍 预期日志

### 浏览器控制台（F12）

成功的语音识别流程：
```
Socket connected
[语音识别] 服务器已启动: 语音识别已启动，请开始说话
[录音] 流式录音已启动 (PCM 16kHz)
[语音识别] 临时结果: 我想去北京
[语音识别] 临时结果: 我想去北京旅游
[语音识别] 最终结果: 我想去北京旅游，5天，预算1万元
[语音识别] 录音已停止
```

### 服务器控制台

成功的语音识别流程：
```
[OK] 语音识别已启动
[语音识别] 连接到: wss://openspeech.bytedance.com/api/v1/stream_asr?...
[OK] 语音识别服务已连接
[语音识别] 临时结果: 我想去北京
[语音识别] 临时结果: 我想去北京旅游
[语音识别] 最终结果: 我想去北京旅游，5天，预算1万元
[OK] 语音识别已停止
```

---

## ❌ 常见问题

### 1. 麦克风无法访问

**问题**：浏览器提示"无法访问麦克风"

**解决方案**：
- 使用 `http://localhost:8080`（不要使用 IP 地址）
- 检查浏览器麦克风权限（地址栏锁图标）
- 关闭其他使用麦克风的应用（Zoom、Teams等）
- Windows：检查"设置 → 隐私 → 麦克风"

### 2. 语音识别失败

**问题**：识别结果为空或错误

**可能原因**：
- API配置错误（检查 `.env` 文件）
- 网络连接问题
- 语音识别服务暂时不可用

**调试步骤**：
1. 检查浏览器控制台的错误信息
2. 检查服务器控制台的日志
3. 确认 API 密钥有效
4. 尝试重启服务器

### 3. 无法生成旅行计划

**问题**：点击"生成旅行计划"按钮没有反应

**可能原因**：
- DeepSeek API 配置错误
- 网络连接问题
- 输入文本为空

**解决方案**：
- 检查 `.env` 中的 `ARK_API_KEY`
- 确认输入框中有文本内容
- 查看浏览器控制台和服务器日志

---

## 📂 项目结构变化

### 已删除的文件（豆包相关）
- `services/doubao_service.py`
- `services/doubao_wrapper.py`
- `static/js/doubao-audio.js`
- `DOUBAO_INTEGRATION_GUIDE.md`

### 新增的文件（语音识别）
- `services/speech_recognition_service.py` - 火山方舟语音识别服务
- `static/js/audio-recorder.js` - 前端录音模块（直接生成PCM）

### 修改的文件
- `config.py` - 语音识别配置
- `app.py` - 集成语音识别服务
- `run.py` - 更新启动信息
- `static/js/app.js` - 语音识别事件处理
- `templates/index.html` - 引入新的录音模块
- `requirements.txt` - 移除 pydub 和 pyaudio

---

## 🎯 技术架构

### 前端
```
用户说话
  ↓
Web Audio API (ScriptProcessorNode)
  ↓
实时转换为 PCM (16kHz, 16bit, 单声道)
  ↓
Base64 编码
  ↓
Socket.IO 发送到后端
```

### 后端
```
接收 PCM 音频数据
  ↓
通过 WebSocket 发送到火山方舟语音识别服务
  ↓
接收识别结果（临时/最终）
  ↓
通过 Socket.IO 发送到前端
```

### 旅行计划生成
```
用户点击"生成旅行计划"
  ↓
发送文本到 /api/travel/plan
  ↓
调用 DeepSeek LLM API
  ↓
生成旅行计划
  ↓
返回并显示在地图上
```

---

## 📞 技术支持

如果遇到问题，请检查：
1. 浏览器控制台（F12）的错误信息
2. 服务器控制台的日志输出
3. `.env` 文件的配置是否正确
4. 网络连接是否正常

---

**祝您使用愉快！** 🎉

