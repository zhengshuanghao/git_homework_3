# 🚀 快速测试指南

## ✅ 已修复的问题

**序列号错误**：`autoAssignedSequence (1) mismatch sequence in request (0)`

**修复**：序列号现在从 **1** 开始（不是 0）

---

## 🔧 快速测试步骤

### 1. 重启服务器

```bash
python run.py
```

### 2. 清除浏览器缓存

`Ctrl + Shift + R` (Windows/Linux) 或 `Cmd + Shift + R` (macOS)

### 3. 测试语音识别

1. 打开 `http://localhost:8080`
2. 点击 **"语音输入"** 标签
3. 点击 **"开始录音"** 按钮
4. 说：**"我想去北京旅游"**
5. 点击 **"停止录音"**
6. 查看识别结果

---

## ✅ 预期日志（成功）

### 服务器控制台

```
[OK] 语音识别服务已连接: wss://openspeech.bytedance.com/api/v3/sauc/bigmodel_async
[调试] 发送初始化请求，seq=1
[OK] 已发送初始化请求
[OK] 初始化成功: {'code': 0, 'message': 'success'}
[OK] 语音识别已启动
[语音识别] 临时结果: 我想去北京
[语音识别] 最终结果: 我想去北京旅游
[OK] 已发送最后一个音频包 (size=3200)
[OK] 语音识别已停止
```

### 浏览器控制台

```
Socket connected
[语音识别] 服务器已启动: 语音识别已启动，请开始说话
[录音] 流式录音已启动 (PCM 16kHz)
[语音识别] 临时结果: 我想去北京
[语音识别] 最终结果: 我想去北京旅游
[语音识别] 录音已停止
```

---

## ❌ 可能的问题

### 问题1: 仍然报 404 或其他连接错误

**解决**：
1. 检查 `.env` 文件中的 `SPEECH_APP_ID` 和 `SPEECH_ACCESS_KEY`
2. 确认 `aiohttp` 已安装：`pip install aiohttp==3.9.1`
3. 确认服务器已重启

### 问题2: 初始化失败

**检查服务器日志**：
- 看到 `[OK] 初始化成功` = ✅ 成功
- 看到 `[X] 初始化失败` = ❌ 失败，查看错误信息

### 问题3: 无识别结果

**检查**：
1. 麦克风是否工作（浏览器控制台看到 `[录音] 流式录音已启动`）
2. 是否发送了音频（服务器日志没有 `[WARN] 未连接`）
3. 是否说话清晰、环境安静

---

## 📝 修改总结

| 文件 | 修改 |
|------|------|
| `services/speech_recognition_service.py` | ✅ 序列号从1开始 |
| `services/speech_recognition_service.py` | ✅ 添加初始化错误处理 |
| `services/speech_recognition_service.py` | ✅ 添加WebSocket关闭检查 |
| `app.py` | ✅ 添加连接状态验证 |

---

## 🎯 测试清单

- [ ] 服务器成功启动
- [ ] 浏览器访问 `http://localhost:8080`
- [ ] 浏览器缓存已清除
- [ ] 点击"语音输入"
- [ ] 点击"开始录音"
- [ ] 服务器日志显示 `[OK] 初始化成功`
- [ ] 说出测试语句
- [ ] 看到临时识别结果（蓝色文字）
- [ ] 点击"停止录音"
- [ ] 看到最终识别结果（绿色文字）
- [ ] 输入框中有识别的文字
- [ ] "生成旅行计划"按钮显示
- [ ] 点击按钮生成旅行计划

---

## 🔍 调试技巧

### 查看详细日志

**服务器控制台**：
- 连接成功：`[OK] 语音识别服务已连接`
- 初始化成功：`[OK] 初始化成功: {'code': 0, ...}`
- 接收音频：（没有 `[WARN]` 警告）
- 识别结果：`[语音识别] 临时/最终结果: ...`

**浏览器控制台（F12）**：
- Socket连接：`Socket connected`
- 录音启动：`[录音] 流式录音已启动 (PCM 16kHz)`
- 识别结果：`[语音识别] 临时/最终结果: ...`

---

## 📞 还有问题？

如果测试失败，请提供：
1. **服务器控制台的完整日志**（从启动到出错）
2. **浏览器控制台的完整日志**（F12 → Console）
3. **具体的错误信息**

---

**现在应该可以正常工作了！** 🎉

关键修复：**序列号从 1 开始**（API要求）

